name: Doctor Health Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # æ¯Žæ—¥ 09:00 UTC ã«å®Ÿè¡Œ
    - cron: '0 9 * * *'

jobs:
  doctor-bootstrap:
    name: Doctor Bootstrap Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Run Doctor Bootstrap Check
        id: bootstrap
        run: |
          node scripts/sw-doctor.js --profile shared-orch-bootstrap --format json > doctor-bootstrap.json
          cat doctor-bootstrap.json

      - name: Parse Bootstrap Results
        run: |
          ISSUES=$(jq '.summary.issues | length' doctor-bootstrap.json)
          WARNINGS=$(jq '.summary.warnings | length' doctor-bootstrap.json)
          echo "Bootstrap Issues: $ISSUES, Warnings: $WARNINGS"
          if [ "$ISSUES" -gt 0 ]; then
            echo "âŒ Bootstrap check failed"
            jq '.summary' doctor-bootstrap.json
            exit 1
          fi
          echo "âœ… Bootstrap check passed"

      - name: Upload Bootstrap Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: doctor-bootstrap-report
          path: doctor-bootstrap.json

  doctor-full:
    name: Doctor Full Check
    runs-on: ubuntu-latest
    needs: doctor-bootstrap
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Run Doctor Full Check
        id: doctor
        run: |
          node scripts/sw-doctor.js --profile shared-orch-doctor --format json > doctor-full.json
          cat doctor-full.json

      - name: Parse Full Results
        run: |
          ISSUES=$(jq '.summary.issues | length' doctor-full.json)
          WARNINGS=$(jq '.summary.warnings | length' doctor-full.json)
          echo "Full Check Issues: $ISSUES, Warnings: $WARNINGS"
          if [ "$ISSUES" -gt 0 ]; then
            echo "âŒ Full check failed"
            jq '.summary' doctor-full.json
            exit 1
          fi
          echo "âœ… Full check passed"

      - name: Upload Full Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: doctor-full-report
          path: doctor-full.json

  doctor-ci-strict:
    name: Doctor CI Strict Check
    runs-on: ubuntu-latest
    needs: doctor-full
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Run Doctor CI Strict Check
        id: ci-strict
        run: |
          node scripts/sw-doctor.js --profile ci-strict --format json > doctor-ci-strict.json
          cat doctor-ci-strict.json

      - name: Evaluate Results
        run: |
          ISSUES=$(jq '.summary.issues | length' doctor-ci-strict.json)
          WARNINGS=$(jq '.summary.warnings | length' doctor-ci-strict.json)
          
          if [ "$ISSUES" -gt 0 ] || [ "$WARNINGS" -gt 0 ]; then
            echo "âŒ CI Strict check failed"
            jq '.summary' doctor-ci-strict.json
            exit 1
          fi
          echo "âœ… All checks passed"

      - name: Upload CI Strict Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: doctor-ci-strict-report
          path: doctor-ci-strict.json

  report-summary:
    name: Doctor Report Summary
    runs-on: ubuntu-latest
    needs: [doctor-bootstrap, doctor-full, doctor-ci-strict]
    if: always()
    steps:
      - uses: actions/download-artifact@v3
        with:
          path: doctor-reports

      - name: Generate Summary
        run: |
          echo "## ðŸ¥ Doctor Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "doctor-reports/doctor-bootstrap-report/doctor-bootstrap.json" ]; then
            BOOTSTRAP_ISSUES=$(jq '.summary.issues | length' doctor-reports/doctor-bootstrap-report/doctor-bootstrap.json)
            BOOTSTRAP_WARNINGS=$(jq '.summary.warnings | length' doctor-reports/doctor-bootstrap-report/doctor-bootstrap.json)
            echo "### Bootstrap Profile" >> $GITHUB_STEP_SUMMARY
            echo "- Issues: $BOOTSTRAP_ISSUES" >> $GITHUB_STEP_SUMMARY
            echo "- Warnings: $BOOTSTRAP_WARNINGS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "doctor-reports/doctor-full-report/doctor-full.json" ]; then
            FULL_ISSUES=$(jq '.summary.issues | length' doctor-reports/doctor-full-report/doctor-full.json)
            FULL_WARNINGS=$(jq '.summary.warnings | length' doctor-reports/doctor-full-report/doctor-full.json)
            echo "### Full Profile" >> $GITHUB_STEP_SUMMARY
            echo "- Issues: $FULL_ISSUES" >> $GITHUB_STEP_SUMMARY
            echo "- Warnings: $FULL_WARNINGS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "doctor-reports/doctor-ci-strict-report/doctor-ci-strict.json" ]; then
            STRICT_ISSUES=$(jq '.summary.issues | length' doctor-reports/doctor-ci-strict-report/doctor-ci-strict.json)
            STRICT_WARNINGS=$(jq '.summary.warnings | length' doctor-reports/doctor-ci-strict-report/doctor-ci-strict.json)
            echo "### CI Strict Profile" >> $GITHUB_STEP_SUMMARY
            echo "- Issues: $STRICT_ISSUES" >> $GITHUB_STEP_SUMMARY
            echo "- Warnings: $STRICT_WARNINGS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
