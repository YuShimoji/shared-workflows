name: Doctor Health Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # æ¯Žæ—¥ 09:00 UTC ã«å®Ÿè¡Œ
    - cron: '0 9 * * *'

jobs:
  doctor-bootstrap:
    name: Doctor Bootstrap Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Run Doctor Bootstrap Check
        id: bootstrap
        run: |
          node scripts/sw-doctor.js --profile shared-orch-bootstrap --format json > doctor-bootstrap.json
          cat doctor-bootstrap.json

      - name: Parse Bootstrap Results
        run: |
          ISSUES=$(jq '.summary.issues | length' doctor-bootstrap.json)
          WARNINGS=$(jq '.summary.warnings | length' doctor-bootstrap.json)
          echo "Bootstrap Issues: $ISSUES, Warnings: $WARNINGS"
          if [ "$ISSUES" -gt 0 ]; then
            echo "âŒ Bootstrap check failed"
            jq '.summary' doctor-bootstrap.json
            exit 1
          fi
          echo "âœ… Bootstrap check passed"

      - name: Upload Bootstrap Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: doctor-bootstrap-report
          path: doctor-bootstrap.json

  doctor-full:
    name: Doctor Full Check
    runs-on: ubuntu-latest
    needs: doctor-bootstrap
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Run Doctor Full Check
        id: doctor
        run: |
          node scripts/sw-doctor.js --profile shared-orch-doctor --format json > doctor-full.json
          cat doctor-full.json

      - name: Parse Full Results
        run: |
          ISSUES=$(jq '.summary.issues | length' doctor-full.json)
          WARNINGS=$(jq '.summary.warnings | length' doctor-full.json)
          echo "Full Check Issues: $ISSUES, Warnings: $WARNINGS"
          if [ "$ISSUES" -gt 0 ]; then
            echo "âŒ Full check failed"
            jq '.summary' doctor-full.json
            exit 1
          fi
          echo "âœ… Full check passed"

      - name: Upload Full Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: doctor-full-report
          path: doctor-full.json

  doctor-ci-strict:
    name: Doctor CI Strict Check
    runs-on: ubuntu-latest
    needs: doctor-full
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Run Doctor CI Strict Check
        id: ci-strict
        run: |
          node scripts/sw-doctor.js --profile ci-strict --format json > doctor-ci-strict.json
          cat doctor-ci-strict.json

      - name: Evaluate Results
        run: |
          ISSUES=$(jq '.summary.issues | length' doctor-ci-strict.json)
          WARNINGS=$(jq '.summary.warnings | length' doctor-ci-strict.json)
          
          if [ "$ISSUES" -gt 0 ] || [ "$WARNINGS" -gt 0 ]; then
            echo "âŒ CI Strict check failed"
            jq '.summary' doctor-ci-strict.json
            exit 1
          fi
          echo "âœ… All checks passed"

      - name: Upload CI Strict Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: doctor-ci-strict-report
          path: doctor-ci-strict.json

  orchestrator-output-validation:
    name: Orchestrator Output Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Find Orchestrator Reports
        id: find-reports
        run: |
          REPORTS=$(find docs/inbox -name "REPORT_ORCH_*.md" -type f | sort)
          if [ -z "$REPORTS" ]; then
            echo "No Orchestrator reports found"
            echo "reports=" >> $GITHUB_OUTPUT
            echo "count=0" >> $GITHUB_OUTPUT
          else
            echo "$REPORTS" | while read -r report; do
              echo "Found: $report"
            done
            echo "reports<<EOF" >> $GITHUB_OUTPUT
            echo "$REPORTS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            COUNT=$(echo "$REPORTS" | wc -l)
            echo "count=$COUNT" >> $GITHUB_OUTPUT
          fi

      - name: Validate Orchestrator Reports
        id: validate
        run: |
          REPORTS="${{ steps.find-reports.outputs.reports }}"
          if [ -z "$REPORTS" ]; then
            echo "âš ï¸ No Orchestrator reports found to validate"
            echo "validated=0" >> $GITHUB_OUTPUT
            echo "failed=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          VALIDATED=0
          FAILED=0
          FAILED_REPORTS=""
          
          echo "$REPORTS" | while read -r report; do
            if [ -z "$report" ]; then
              continue
            fi
            echo ""
            echo "=========================================="
            echo "Validating: $report"
            echo "=========================================="
            
            if node scripts/orchestrator-output-validator.js "$report"; then
              echo "âœ… $report: Validation passed"
              VALIDATED=$((VALIDATED + 1))
            else
              echo "âŒ $report: Validation failed"
              FAILED=$((FAILED + 1))
              FAILED_REPORTS="${FAILED_REPORTS}${report}\n"
            fi
          done
          
          # çµæžœã‚’é›†è¨ˆï¼ˆwhileãƒ«ãƒ¼ãƒ—ã®å¤–ã§è©•ä¾¡ã™ã‚‹ãŸã‚ã€ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ï¼‰
          echo "$REPORTS" | while read -r report; do
            if [ -z "$report" ]; then
              continue
            fi
            if ! node scripts/orchestrator-output-validator.js "$report" 2>&1; then
              echo "$report" >> /tmp/failed_reports.txt
            fi
          done || true
          
          if [ -f /tmp/failed_reports.txt ]; then
            FAILED_COUNT=$(wc -l < /tmp/failed_reports.txt)
            echo "âŒ Validation failed for $FAILED_COUNT report(s):"
            cat /tmp/failed_reports.txt
            rm -f /tmp/failed_reports.txt
            exit 1
          else
            TOTAL=$(echo "$REPORTS" | grep -v '^$' | wc -l)
            echo "âœ… All $TOTAL Orchestrator report(s) passed validation"
          fi

      - name: Upload Validation Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: orchestrator-validation-results
          path: |
            docs/inbox/REPORT_ORCH_*.md

  report-summary:
    name: Doctor Report Summary
    runs-on: ubuntu-latest
    needs: [doctor-bootstrap, doctor-full, doctor-ci-strict, orchestrator-output-validation]
    if: always()
    steps:
      - uses: actions/download-artifact@v3
        with:
          path: doctor-reports

      - name: Generate Summary
        run: |
          echo "## ðŸ¥ Doctor Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "doctor-reports/doctor-bootstrap-report/doctor-bootstrap.json" ]; then
            BOOTSTRAP_ISSUES=$(jq '.summary.issues | length' doctor-reports/doctor-bootstrap-report/doctor-bootstrap.json)
            BOOTSTRAP_WARNINGS=$(jq '.summary.warnings | length' doctor-reports/doctor-bootstrap-report/doctor-bootstrap.json)
            echo "### Bootstrap Profile" >> $GITHUB_STEP_SUMMARY
            echo "- Issues: $BOOTSTRAP_ISSUES" >> $GITHUB_STEP_SUMMARY
            echo "- Warnings: $BOOTSTRAP_WARNINGS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "doctor-reports/doctor-full-report/doctor-full.json" ]; then
            FULL_ISSUES=$(jq '.summary.issues | length' doctor-reports/doctor-full-report/doctor-full.json)
            FULL_WARNINGS=$(jq '.summary.warnings | length' doctor-reports/doctor-full-report/doctor-full.json)
            echo "### Full Profile" >> $GITHUB_STEP_SUMMARY
            echo "- Issues: $FULL_ISSUES" >> $GITHUB_STEP_SUMMARY
            echo "- Warnings: $FULL_WARNINGS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "doctor-reports/doctor-ci-strict-report/doctor-ci-strict.json" ]; then
            STRICT_ISSUES=$(jq '.summary.issues | length' doctor-reports/doctor-ci-strict-report/doctor-ci-strict.json)
            STRICT_WARNINGS=$(jq '.summary.warnings | length' doctor-reports/doctor-ci-strict-report/doctor-ci-strict.json)
            echo "### CI Strict Profile" >> $GITHUB_STEP_SUMMARY
            echo "- Issues: $STRICT_ISSUES" >> $GITHUB_STEP_SUMMARY
            echo "- Warnings: $STRICT_WARNINGS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "### Orchestrator Output Validation" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.orchestrator-output-validation.result }}" == "success" ]; then
            echo "- Status: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Status: âŒ Failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY