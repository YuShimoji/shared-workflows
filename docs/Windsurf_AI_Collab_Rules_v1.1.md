# Windsurf: AI 協調開発ルール v1.1

> 本ドキュメントは、v1.0 を拡張し、「複合ミッション・ワークフロー」「AI_CONTEXT.md 運用」「CI 連携マージ」を統合した最新版です。全プロジェクトで統一して適用します。

## 0. 起動シーケンス（プロジェクト抽象化）

- 本ドキュメントは全プロジェクト共通の Single Source of Truth（SSOT）です。
- AI は「各プロジェクトの」リポジトリ直下にある `AI_CONTEXT.md` を起動時に読み込みます（中央リポジトリのファイルは参照しません）。
- `AI_CONTEXT.md` が存在しない場合は、付録 A のテンプレートに従って最小構成を生成し、プロジェクト側へ追加することを推奨します。
- ルール本文は常に本リポジトリの `docs/Windsurf_AI_Collab_Rules_v1.1.md` を参照し、各プロジェクト側の `docs/Windsurf_AI_Collab_Rules_v1.1.md` は中央リポジトリへのリンクのみを保持します。
- Pre-flight（プロジェクト側）では `AI_CONTEXT.md` の存在と必須フィールド（最終更新/ミッション/ブランチ/次の中断可能点等）を静的検証してください。

## 1. 目的と適用範囲

- 人間と AI エージェントが協調し、高速かつ安全に価値を継続提供するための原則・手順・監査要件を定義します。
- 適用対象はコード生成、テスト、デプロイ、ドキュメント生成、インフラ操作など全ての開発活動です。

## 2. 用語定義

- AI: 本プロジェクトで自動化/支援を行うエージェント（actor_id を付与）。
- Issue: すべての作業の起点となるトラッキング単位。
- Tier: 実行リスク分類。Tier 1（低）/Tier 2（中）/Tier 3（高）。
- Pre-flight Check: 実行前の自動検証群。
- 複合ミッション: 実装・改善・リファクタ・リリース準備等を内包する、AI の長期作業単位。単一の Issue/ブランチ/PR に集約する。
- AI_CONTEXT.md: リポジトリ直下で AI の状態を永続化/同期するための単一ソース。最終更新日時、現在ミッション、関連 Issue/PR、進捗、次の中断可能点、将来提案等を記録。
- 中断可能点: 人間が介入/停止しやすい工程上の安全な区切り（例: PR 作成直後、CI 成功直後、デプロイ前）。

## 3. 原則（Principles）

### 3.1 段階的権限付与（Tiered Delegation）

- Tier 1（低）: ドキュメント更新、スタイル修正、軽微なテスト・CI設定。AIは自律実行可（Pre-flight合格時）。
- Tier 2（中）: 機能実装/仕様追加等。AIがPRを作成。品質ゲート（テストカバレッジ≥80%、脆弱性High/Critical=0）が満たされれば自動マージ可。
- Tier 3（高）: 本番データ変更、DBマイグレーション、デプロイ等。AIは提案のみ。シニア承認と二段階承認必須。

### 3.2 自律性の範囲

- Assume YesはTier 1のみ適用。Tier 2/3は承認フローに従うが、プロジェクトタイプにより調整可能（例: Web開発で高速モード適用時、Tier 2の自動マージ閾値を緩和）。
- すべてのAI操作はPR/変更ログを生成。ただし、ダイレクトコミットオプション（小規模変更でPRスキップ）を許可。
- 「CI連携マージ」: CI成功時自動マージ（自己PR承認省略）。品質ゲート未達時は人間介入を促す。

### 3.3 可観測性と監査

- すべてのAI操作はJSONログに記録。ただし、詳細ログは短期保存（90日）、要約ログは長期アーカイブ。
- 例外条項: 緊急時やクリエイティブ作業でルール逸脱を認め、理由をログに記録。

### 3.4 運用標準

- 返信は日本語を推奨。ただし、効果優先で英語や簡潔モードを選択可。
- タスク化を推奨。ただし、単純作業時は簡略化。
- 進捗報告は必須だが、フォーマットは柔軟（テンプレート使用は推奨）。
- 応答モード: 「標準モード」（テンプレート遵守）と「フレキシブルモード」（効果優先）を状況に応じ自動選択。
- フィードバックループ: 応答後に人間から効果評価を収集し、ルール改善に反映。

## 4. ワークフロー（プロジェクトタイプ別対応）

1) 着想: AIはコード分析/抽象要求/将来提案に基づきIssueを起票可。IssueにはGoal/ToDo/受入基準/影響範囲/推定リスク（Tier）を明記。
2) 計画: タスク分解/サブタスク化。Patchスコープ定義。
3) 実装: ブランチ命名・コミット規約に従い進める。
4) 検証: CIでユニット/統合/静的解析/セキュリティスキャン。Pre-flight合格をマージ条件。
5) 統合: ルール3.1/3.2に従ってマージ（自動マージ条件を満たす場合はAIが実行）。
6) 文書化: 変更を`docs/`に反映し、「最終更新日時」「更新者」を明記。

### 4.1 複合ミッション・ワークフロー

- 関連タスク（実装/改善/リファクタ/リリース準備）を1つの「複合ミッション」として束ね、単一のIssue/ブランチ/PRに集約。
- 中間報告は原則不要。AIは`AI_CONTEXT.md`を更新し続け、工程の「中断可能点」を明示。
- 分割ミッション: 1作業あたり30分を超える場合はサブミッションに自動分割。

### 4.2 `AI_CONTEXT.md`運用

- 位置: リポジトリ直下に`AI_CONTEXT.md`。
- 更新タイミング: 作業開始時の読込、コミット前、PR作成後、CI完了後など区切りで更新。
- 記載内容: 最終更新日時（ISO8601）、現在のミッション、関連Issue/PR、進捗、次の中断可能点、決定事項、リスク、将来提案（Backlog）。
- モードフラグ: `mode: standard`または`mode: fast`を記載し、自動運用を補助。
- 端末間・会話セッションに依存せず、いつでも再開可能な状態を維持。

### 4.3 対話的管理（中断可能点と提案）

- チャット報告時は「次の安全な中断可能点」を明示（例: 「PR作成後」）。
- Backlogには将来検討事項を蓄積し、ミッション完了時に再確認。
- 介入トリガー: Tier 3到達時、リトライ3回失敗時などで人間介入を促す。

### 4.4 GitHub自律操作

- AIはIssue/ブランチ/PR作成、ラベル付与、PRの自動マージ（ルール準拠）を実施。
- 自動マージは「CI連携マージ」原則に従う。Tier 2は品質ゲート合格時のみ自動。
- 高速モードでは小規模変更のダイレクトコミットを許可。自己PRはCI成功後にそのままマージ。

### 4.5 命名/コミット規約

- ブランチ: `feature/ISSUE-<id>-<slug>`（許容: `feature/#<id>-<slug>`）。
- コミット: `type(scope): short description [closes #<issue>]`。
- ドラフトコミット: `draft: true`フラグでビルド未通過の暫定コミットを許可し、後続で正式化。

### 4.6 Pre-flight Check（必須）

1) 依存関係の整合（lockの整合）。
2) 必須環境変数の存在/妥当性。
3) Linterエラー0。
4) テスト実行と閾値（全体≥80%、重要モジュール≥90%推奨）。高速モード時は≥50%。
5) セキュリティスキャン（High/Critical=0、Mediumは影響評価と承認）。
6) 影響範囲レポート（本番影響: 変更ファイル一覧/DB操作/外部API影響）。
7) プロジェクト固有のSmoke/静的検証（例: `scripts/dev-check.js`）。

### 4.7 セキュリティ/秘密情報

- API Key/資格情報はハードコード禁止。必要な場合は安全なストアを使用。
- セキュリティ事前チェックでハードコードや秘匿情報を静的に検出。

### 4.8 バックアウト/ロールバック

- 影響が大きい変更はリリースノートとロールバック手順をPRに明記。

### 4.9 バージョニング/リリース

- セマンティックバージョニングに準拠し、`CHANGELOG`/`VERSION`を更新。Tierに応じてCI成功後に自動マージ可。

### 4.10 ドキュメント生成

- Doxygen/PlantUMLなどで設計・変更点を`docs/`に反映。

## 5. 自動化・冪等性・リトライ

- 冪等運用。失敗時は最大3回まで自動リトライ。3回失敗で中断し、Issueにエラーレポートを追加。
- バックアップブランチを自動作成し、他端末での並行作業を可能に。

## 6. 監査/ログ

- 監査用JSONログ（3.3参照）を生成し、PR/Issueに紐づくcorrelation-idを付与。
- ログ階層化: 詳細ログは短期保持、要約ログは長期保持で管理を簡素化。

## 7. プロジェクトタイプ別ガイド

- **検知方法**: リポジトリ直下に`PROJECT_TYPE`ファイルを配置（例: `web`/`unity`/`standard`）。未指定時は`standard`。
- **高速モード（Web/Unity向け）**:
  - Issue/PRを最小限に抑え、ダイレクトコミットを許可。
  - Pre-flight閾値を緩和（テストカバレッジ≥50%でPush可）。
  - Tier 1/2の小規模変更は自動承認を拡大。
- **標準モード**: 従来のIssueドリブン開発を維持。
- **切り替え**: `AI_CONTEXT.md`のモードフラグで操作。検知スクリプトやCIで自動適用可能。

---

## 付録 A: AI_CONTEXT.md テンプレート

```markdown
# AI Context
- 最終更新: <ISO8601>
- 現在のミッション: <title> (#<issue>)
- ブランチ: <branch>
- 関連: Issue <url>, PR <url>
- 進捗: <percentage>% / ステータス: <phase>
- 次の中断可能点: <when>
- モード: <standard/fast>

## 決定事項
- <decision/why>

## リスク/懸念
- <risk/mitigation>

## Backlog（将来提案）
- <idea/impact/rough-scope>
```

## 付録 B: Issue/PR テンプレ（要約）

- Issue: Goal/Scope/DoD/Risk(Tier)/影響範囲/関連リンク。
- PR: 概要/変更点/テスト/リスク/関連Issue/中断可能点（例: 「CI成功後」）。

## 付録 C: 典型フロー（複合ミッション）

1) Issue作成（高速モード時はスキップ可） → 2) ブランチ作成 → 3) 実装/ドキュメント/テスト → 4) Smoke/Pre-flight → 5) PR作成（高速モード時はダイレクトコミット） → 6) CI成功 → 7) 自動マージ（CI連携マージ） → 8) リリース（必要時）。

## 付録 D: 効果的なメッセージ作成ガイド

- **基本原則**: 目標・優先順位・制約を明確に記載（例: 「新規機能を実装。優先: 高。制約: テスト必須。」）。
- **簡潔さ**: 不要な詳細は省き、箇条書きで要点を提示。
- **コンテキスト維持**: 「続きから進めて」とだけ指示せず、必要な背景を補足。
- **避けるべき表現**: 効果のない「続けてください」や過度に堅いテンプレート依存。
- **ベストプラクティス例**: 「Unityプロジェクトで高速モード適用。ビルドエラー解決を最優先で対応。」
