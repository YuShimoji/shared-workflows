# Windsurf: AI 協調開発ルール v1.1

> 本ドキュメントは、v1.0 を拡張し、「複合ミッション・ワークフロー」「AI_CONTEXT.md 運用」「CI 連携マージ」を統合した最新版です。全プロジェクトで統一して適用します。

## 0. 起動シーケンス（プロジェクト抽象化）

- 本ドキュメントは全プロジェクト共通の Single Source of Truth（SSOT）です。
- AI は「各プロジェクトの」リポジトリ直下にある `AI_CONTEXT.md` を起動時に読み込みます（中央リポジトリのファイルは参照しません）。
- `AI_CONTEXT.md` が存在しない場合は、付録 A のテンプレートに従って最小構成を生成し、プロジェクト側へ追加することを推奨します。
- ルール本文は常に本リポジトリの `docs/Windsurf_AI_Collab_Rules_v1.1.md` を参照し、各プロジェクト側の `docs/Windsurf_AI_Collab_Rules_v1.1.md` は中央リポジトリへのリンクのみを保持します。
- Pre-flight（プロジェクト側）では `AI_CONTEXT.md` の存在と必須フィールド（最終更新/ミッション/ブランチ/次の中断可能点等）を静的検証してください。

## 1. 目的と適用範囲

- 人間と AI エージェントが協調し、高速かつ安全に価値を継続提供するための原則・手順・監査要件を定義します。
- 適用対象はコード生成、テスト、デプロイ、ドキュメント生成、インフラ操作など全ての開発活動です。

## 2. 用語定義

- AI: 本プロジェクトで自動化/支援を行うエージェント（actor_id を付与）。
- Issue: すべての作業の起点となるトラッキング単位。
- Tier: 実行リスク分類。Tier 1（低）/Tier 2（中）/Tier 3（高）。
- Pre-flight Check: 実行前の自動検証群。
- 複合ミッション: 実装・改善・リファクタ・リリース準備等を内包する、AI の長期作業単位。単一の Issue/ブランチ/PR に集約する。
- AI_CONTEXT.md: リポジトリ直下で AI の状態を永続化/同期するための単一ソース。最終更新日時、現在ミッション、関連 Issue/PR、進捗、次の中断可能点、将来提案等を記録。
- 中断可能点: 人間が介入/停止しやすい工程上の安全な区切り（例: PR 作成直後、CI 成功直後、デプロイ前）。

## 3. 原則（Principles）

### 3.1 段階的権限付与（Tiered Delegation）

- Tier 1（低）: ドキュメント更新、スタイル修正、軽微なテスト・CI 設定。AI は自律実行可（要 Pre-flight 合格）。
- Tier 2（中）: 機能実装/仕様追加等。AI が PR を作成。定義された品質ゲート（例: テストカバレッジ≥90%、脆弱性 High/Critical=0）が満たされれば自動マージ可。
- Tier 3（高）: 本番データ変更、DB マイグレーション、デプロイ/本番インフラ変更等。AI は提案のみ。シニア承認と二段階承認が必須。

### 3.2 自律性の範囲

- Assume Yes は Tier 1 のみ適用。Tier 2/3 は承認フローに従う。
- すべての AI 操作は PR/変更ログを自動生成し、理由・実行コマンドを記録する。
- 「CI 連携マージ」: CI が成功した PR は AI が自動でマージする（自己 PR の承認は省略）。Tier 2 は品質ゲート合格が条件。品質ゲートを満たした PR は AI の判断で自律的にマージしてよい。

### 3.3 可観測性と監査

- すべての AI 操作は JSON 形式ログに記録（timestamp, actor, issue-id, action, diff/changes, preflight-result, environment, correlation-id）。
- ログ保持: 90 日ホット、3 年アーカイブ。

### 3.4 運用標準（毎回の開発の進め方）

- 返信は必ず日本語で行う。
- タスク化して進め、区切りの良いところでこまめにプッシュまで行う。
- 大項目・中項目・小項目を設定し、各タスクの目的と完了条件を明確化。
- 進捗と今後の計画を都度明示し、それに従って作業を進める。
- 自律的にテスト（単体/統合/静的）を実行し、正常性を確認。
- 手動テストが必要な場合は、完全な手順をドキュメント化。
- Issue とドキュメントを頻繁に点検・更新し最新に保つ。
- 長期/中期/短期の「開発の区切り」を意識し、状態を点検・更新。

## 4. ワークフロー（Issue 駆動開発）

1) 着想: AI はコード分析/抽象要求/将来提案に基づき Issue を起票可。Issue には Goal/ToDo/受入基準/影響範囲/推定リスク（Tier）を明記。
2) 計画: タスク分解/サブタスク化。Patch スコープ定義。
3) 実装: ブランチ命名・コミット規約に従い進める。
4) 検証: CI でユニット/統合/静的解析/セキュリティスキャン。Pre-flight 合格をマージ条件。
5) 統合: ルール 3.1/3.2 に従ってマージ（自動マージ条件を満たす場合は AI が実行）。
6) 文書化: 変更を docs/ に反映。ドキュメントへ「最終更新日時」「更新者」を明記。

### 4.1 複合ミッション・ワークフロー

- 関連タスク（実装/改善/リファクタ/リリース準備）を 1 つの「複合ミッション」として束ね、単一の Issue/ブランチ/PR に集約。
- Issue 起票は AI が自律的に実施できる。必要な情報（Goal/Scope/DoD/リスク等）を満たす限り、事前承認なしで作成してよい。
- 中間報告は原則不要。AI は AI_CONTEXT.md を更新し続け、工程の「中断可能点」を明示。
- 例: Mission N を単一 PR で完成 → CI 成功 → AI が自動マージ。

### 4.2 AI_CONTEXT.md 運用

- 位置: リポジトリ直下に `AI_CONTEXT.md`。
- 更新タイミング: 作業開始時の読込、作業の区切り（コミット前/PR 作成後/CI 完了後など）に更新。
- 記載内容: 最終更新日時（ISO8601）、現在のミッション、関連 Issue/PR、進捗、次の中断可能点、決定事項、リスク、将来提案（Backlog）。
- 端末間/会話セッション非依存で、どこからでも再開可能にする。

### 4.3 対話的管理（中断可能点と提案）

- チャット報告時は「次の安全な中断可能点」を明示（例: 「PR 作成後」）。
- 将来検討事項は AI_CONTEXT.md の Backlog に蓄積し、ミッション完了報告時に提案。

### 4.4 GitHub 自律操作

- AI は Issue/ブランチ/PR 作成、ラベル付与、PR の自動マージ（ルール準拠）を実施。
- 自動マージは「CI 連携マージ」原則に従う。Tier 2 は品質ゲート合格時のみ自動。マージ後は AI が自律的に作業ブランチを削除する。
- 自己 PR は Approve 不可のため、承認を省略し、CI 成功後に直接マージする（CI 連携マージ）。

### 4.5 命名/コミット規約

- ブランチ: `feature/ISSUE-<id>-<slug>`（許容: `feature/#<id>-<slug>`）。
- コミット: `type(scope): short description [closes #<issue>]`。
- type: feat/fix/chore/docs/refactor/test/build/ci/release など。

### 4.6 Pre-flight Check（必須）

1. 依存関係の整合（lock の整合）。
2. 必須環境変数の存在/妥当性。
3. Linter エラー 0。
4. テスト実行と閾値（全体 ≥80%、重要モジュール ≥90% 推奨）。
5. セキュリティスキャン（High/Critical=0、Medium は影響評価と承認）。
6. 影響範囲レポート（本番影響: 変更ファイル一覧/DB 操作/外部 API 影響）。
7. プロジェクト固有の Smoke/静的検証（例: `scripts/dev-check.js`）。

### 4.7 セキュリティ/秘密情報

- API Key/資格情報はハードコード禁止。必要な場合は安全なストアを使用。

### 4.8 バックアウト/ロールバック

- 影響が大きい変更はリリースノート/ロールバック手順を PR に明記。

### 4.9 バージョニング/リリース

- セマンティックに準拠し、CHANGELOG/VERSION を更新。リリース PR は CI 成功後に自動マージ可（Tier に応じて）。

### 4.10 ドキュメント生成

- Doxygen/PlantUML 等により設計/変更点を docs/ に反映。

## 5. 自動化・冪等性・リトライ

- 冪等運用。失敗時は最大 3 回まで自動リトライ。3 回失敗で中断し、Issue にエラーレポート付与。

## 6. 監査/ログ

- 監査用 JSON ログ（3.3 参照）を生成。PR/Issue に紐づけ可能な correlation-id を使用。

---

## 付録 A: AI_CONTEXT.md テンプレート

```markdown
# AI Context
- 最終更新: <ISO8601>
- 現在のミッション: <title> (#<issue>)
- ブランチ: <branch>
- 関連: Issue <url>, PR <url>
- 進捗: <percentage>% / ステータス: <phase>
- 次の中断可能点: <when>

## 決定事項
- <decision/why>

## リスク/懸念
- <risk/mitigation>

## Backlog（将来提案）
- <idea/impact/rough-scope>
```

## 付録 B: Issue/PR テンプレ（要約）

- Issue: Goal/Scope/DoD/Risk(Tier)/影響範囲/関連リンク。
- PR: 概要/変更点/テスト/リスク/関連 Issue/中断可能点（例: 「CI 成功後」）。

## 付録 C: 典型フロー（複合ミッション）

1) Issue 作成 → 2) ブランチ作成 → 3) 実装/ドキュメント/テスト → 4) Smoke/Pre-flight → 5) PR 作成 → 6) CI 成功 → 7) 自動マージ（CI 連携マージ） → 8) リリース（必要時）。
