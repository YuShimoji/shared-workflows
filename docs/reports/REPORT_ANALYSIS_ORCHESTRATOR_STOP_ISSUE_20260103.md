# Report: Orchestrator停止判定問題の分析

**Timestamp**: 2026-01-03T05:30:00+09:00  
**Actor**: AnalysisAgent  
**Type**: Analysis  
**Issue**: Orchestratorが「停止していません」と返答したが、実際には固定5セクション形式の出力が不完全で、ユーザーから見ると「停止している」ように見えた

---

## 問題の概要

Vastcoreプロジェクトでのワークフローテスト中、以下の問題が発生：

1. **ユーザーの指摘**: 「作業が停止してしまっています」
2. **AIの返答**: 「止まっていません、こちら側では git push origin main まで完了しています」
3. **実際の状況**: 作業は継続されていたが、**固定5セクション形式の出力が不完全**だった

---

## 根本原因の分析

### 1. プロトコル違反の詳細

**要求される出力形式**（`ORCHESTRATOR_DRIVER.txt` より）:
```
1. ## 現状
2. ## 次のアクション
3. ## ガイド
4. ## メタプロンプト再投入条件
5. ## 改善提案（New Feature Proposal）
```

**実際の出力**（ログより）:
- ✅ `## 現状` - 存在（「現状（停止していません）」）
- ✅ `## 次のアクション` - 存在（選択肢1-3が含まれている）
- ❌ `## ガイド` - **欠落または不完全**
- ❌ `## メタプロンプト再投入条件` - **欠落または不完全**
- ❌ `## 改善提案（New Feature Proposal）` - **欠落**

### 2. 問題の影響

1. **ユーザーの混乱**: 固定5セクション形式が不完全なため、「停止している」と判断された
2. **プロトコル違反**: `EVERY_SESSION.md` の「失敗と判断する結果」に該当：
   - 「Orchestrator が固定5セクション以外を出力（例: 結論/作業評価）」
   - 「`## 次のアクション` にユーザー返信テンプレが無い（= report-validator でも ERROR になる）」

### 3. なぜ「停止していません」と返答したのか

- 実際には作業（git push、プロンプトファイルのコピー、コミット等）は継続されていた
- しかし、**チャット出力の形式が不完全**だったため、ユーザーから見ると「停止している」ように見えた
- AIは「作業は継続している」という事実を伝えたが、**プロトコルに従った出力形式を守っていなかった**

---

## 解決策の提案

### 1. 即座の対応（プロトコル強化）

**`ORCHESTRATOR_DRIVER.txt` の強化**:
- 「停止していません」という返答をする前に、**必ず固定5セクション形式で出力する**ことを明記
- 各セクションが欠落している場合、**未完了として扱う**ことを明記

**`00_core.md` の強化**:
- チャット出力前に「5セクション全てが揃っているか」をチェックする手順を追加
- セクションが欠落している場合は、**必ず補完してから出力する**ことを明記

### 2. 検証スクリプトの追加

**`scripts/orchestrator-output-validator.js`** を作成:
- Orchestratorのチャット出力を検証
- 固定5セクションの存在を確認
- 各セクションの内容が適切か（特に「次のアクション」にユーザー返信テンプレが含まれているか）を確認

### 3. ドキュメントの明確化

**`EVERY_SESSION.md` の更新**:
- 「停止していません」という返答をする場合でも、**必ず固定5セクション形式で出力する**ことを明記
- 作業が継続している場合でも、**プロトコルに従った出力形式を守る**ことを強調

---

## 推奨される修正

### 修正1: `ORCHESTRATOR_DRIVER.txt` の更新

```diff
## 2. 停止時の必須アウトプット

途中で停止する場合でも、以下を必ず残す:

1. MISSION_LOG.md を更新（現在フェーズ、ブロッカー、次手）
2. チャットに「停止理由」と「次の選択肢（1-3件）」を提示
3. 沈黙して終了することは禁止
+
+**重要**: 「停止していません」という返答をする場合でも、**必ず固定5セクション形式で出力する**こと。
+作業が継続している場合でも、プロトコルに従った出力形式を守ること。
```

### 修正2: `00_core.md` の更新

```diff
## チャット出力形式（固定5セクション）
1. `## 現状`
2. `## 次のアクション`
3. `## ガイド`
4. `## メタプロンプト再投入条件`
5. `## 改善提案（New Feature Proposal）`
+
+**必須チェック**: 出力前に、5セクション全てが揃っているか確認すること。
+セクションが欠落している場合は、**必ず補完してから出力する**こと。
```

### 修正3: 検証スクリプトの追加

`scripts/orchestrator-output-validator.js` を作成し、Orchestratorの出力を自動検証する。

---

## 結論

**問題の本質**:
- 作業は継続されていたが、**プロトコルに従った出力形式が不完全**だった
- これにより、ユーザーから見ると「停止している」ように見えた

**解決策**:
1. プロトコルの明確化（「停止していません」という返答でも固定5セクション形式を守る）
2. 検証スクリプトの追加（出力形式の自動検証）
3. ドキュメントの更新（プロトコル違反の防止）

---

## 次のアクション

1. `ORCHESTRATOR_DRIVER.txt` と `00_core.md` を上記の通り更新
2. `scripts/orchestrator-output-validator.js` を作成
3. `EVERY_SESSION.md` に「停止していません」という返答時のプロトコルを明記
4. テスト: Vastcoreプロジェクトで再テストし、問題が解決したか確認


