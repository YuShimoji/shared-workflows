# Windsurf: AI 協調開発ルール (SSOT / latest)

> **重要**: 本ファイルは Windsurf 環境における協調開発の単一正本（SSOT）です。  
> すべての AI エージェントおよび人間オペレータは、本ルールを最優先で遵守してください。

---

## 変更サマリー（v1.1 → v2.0）

- ✅ **実行フローの完全明確化**: 各ステップで「自動実行 or 待機」を明示
- ✅ **クリーンアップの義務化**: PR作成前の必須チェックリストを追加
- ✅ **簡易化**: Tier分類を簡素化し、判断の曖昧性を排除
- ✅ **自動マージの確実性**: CI成功 → 即座に自動マージの単純フロー
- ✅ **中断禁止ゾーン**: PR作成からマージまで人間の介入を不要に

---

## 0. 起動シーケンス

### AIの起動時動作（毎回必ず実行）

1. **AI_CONTEXT.md の読み込み**: プロジェクトルートの `AI_CONTEXT.md` を最初に読む
2. **オーケストレーション用プロンプト（任意）の読み込み**: プロジェクトルートの `ORCHESTRATION_PROMPT.md` を運用している場合は読む（テンプレ: `templates/ORCHESTRATION_PROMPT.md`）
3. **ミッション確認**: 現在のミッションと進捗を把握
4. **継続 or 新規判定**: 継続作業なら中断可能点から再開、新規ならIssue作成から開始

### AI_CONTEXT.md が存在しない場合

- 付録Aのテンプレートに従って自動生成（Tier 1操作）
- プロジェクトルートに配置し、初期状態を記録

---

## 1. 基本原則

### 1.1 作業の起点

- **すべての作業はIssueから開始**: 抽象的な要求もIssueに変換
- **AI自律Issue起票**: AIはコード分析・将来提案に基づきIssueを自律的に作成可能

### 1.2 応答言語

- **すべての応答は日本語**: ドキュメント、コミットメッセージ、PR本文すべて日本語

### 1.3 タスク駆動開発

- 大項目/中項目/小項目に分解
- 進捗を `AI_CONTEXT.md` に記録
- 区切りごとにコミットし、共有が必要な場合はプッシュする（外部通信のため必要に応じて承認）

### 1.4 コマンド実行ポリシー（高速化）

- **原則**: AI は作業を止めずに進めるため、ローカルで安全なコマンドは自律実行してよい
  - 例: 読み取り/検索/差分確認/静的解析/テスト/ビルド/フォーマット（プロジェクト内に閉じる範囲）
- **例外**: 以下に該当する場合は事前承認を取る
  - **外部通信**（例: `git fetch/pull/push`、パッケージ取得、外部API呼び出し）
  - **破壊的/復旧困難な操作**（例: 削除、強制上書き、`reset`、`rebase`、`force push`）
  - **依存関係の追加/更新**（例: `npm install`、`pip install`）
  - **長時間/高負荷/大量出力が見込まれる操作**（目安: 数分以上、または大量ログ）

#### 運用オプション: GitHub操作を自動承認する

プロジェクト/組織の運用として「普段から push・PR作成・マージまで自動承認」する場合は、外部通信（`git fetch/pull/push` 等）や GitHub 操作について **承認待ちで停止しない** 運用にしてよい:

- 条件: 実行環境（ツール設定/CI権限/ルール）側で、GitHub操作の自動承認が有効になっている
- この場合の扱い: `git fetch/pull/push` や PR作成/マージ等は、都度の確認を省略して自律実行してよい
- ただし、`force push` / `rebase` / `reset` のような履歴破壊・復旧困難な操作は、引き続き慎重に扱い、必要なら方針確認を取る

#### ダブルチェック（必須）: 失敗の取りこぼし・スタック・虚偽完了の防止

以下は **効率より正確性を優先**し、毎回必ず実施する。

- **終了判定のダブルチェック**:
  - コマンド実行後は、必ず「終了した」ことを確認してから次に進む。
  - 待機が必要な場合は、必ず **タイムアウト（上限時間）** と **打ち切り条件** を定義し、超過したら「タイムアウト」と明言して次の手を出す。
- **成功判定のダブルチェック**:
  - 成功判定は必ず **2段階** で行う:
    - 1) 実行結果（エラー表示/非0終了/拒否/競合/タイムアウト等）
    - 2) 目的状態の確認（Git状態/生成物/ログ等）
  - 失敗が表示された場合は、その場で「失敗」と明言し、根拠と次の対応を提示する。
- **成果物のダブルチェック**:
  - 実装・修正・運用タスクは「成果物が確認できる」ことを完了条件に含める。
  - **「実装完了」の禁止条件**: 実際の差分や動作確認が提示できない場合は完了として扱わず「未完了」と明言する。

---

## 2. 簡素化されたTier分類

### Tier 1（完全自律）
- ドキュメント更新、スタイル修正、軽微なテスト修正、AI_CONTEXT.md 更新。

### Tier 2（自動PR→CI→自動マージ）
- 機能実装、バグ修正、リファクタリング、新規テスト追加。
- **実行ルール**: 実装 → クリーンアップチェック → PR自動作成 → CI成功 → **即座に自動マージ**。

### Tier 3（人間承認必須）
- 本番DB変更、本番デプロイ、セキュリティ設定、major バージョンアップ。

---

## 3. 必須フロー（Tier 2の標準）

### Step 4: クリーンアップチェック（★重要★）
**PR作成前に必ず実行する義務的チェックリスト**:
- [ ] デバッグ出力（console.log等）の削除
- [ ] 不要なコメントアウト、未使用の変数/importの削除
- [ ] TODO/FIXMEの対応またはIssue化
- [ ] 不要な空行の整理

---

## 4. AI_CONTEXT.md 運用

- **配置**: プロジェクトルート直下。
- **更新**: 作業開始時、作業の区切り、完了時に必ず更新。
- **フィールド**: 最終更新、ミッション、進捗、次の中断可能点、決定事項、Backlog。

---

## 5. 履歴と互換性

- 本ルールは v2.0 をベースとした統合正本です。
- 旧バージョン（v1.1, v2.0）は履歴参照用として `docs/` 配下に保持されますが、AI は常に本ファイル（latest）を参照してください。

---

**このドキュメントは `YuShimoji/shared-workflows` リポジトリで管理されています。**
